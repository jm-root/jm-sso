var jm=jm||{};"undefined"!=typeof exports&&"undefined"!=typeof module&&(jm=require("jm-sdk-core")),function(){var t=jm.sdk,e=(t.$,t.storage),i=t.consts.ERR;t.on("init",function(e){e.sso=e.sso||{},e.sso.uri=e.sso.uri||e.uri,e.sso.timeout=e.sso.timeout||e.timeout,t.sso.init(e.sso)}),t.sso={init:function(e){var i=(e=e||{}).uri,n=e.prefix||"/sso";this.uri=i+n,jm.enableEvent(this),t.enableAjax(this,{timeout:e.timeout||0})},signup:function(t,e){var i=this;e=e||function(){},this.post({url:this.uri+"/signup",data:t},function(n,o){!n&&o&&o.id||(n=new Error("注册失败")),n?e(n,o):i.signon(t,e),i.emit("signup",n,o)})},signon:function(t,i){var n=this;i=i||function(){},this.post({url:this.uri+"/signon",data:t},function(o,r){!o&&r&&r.id?(e.setItem("token",r.token),e.setItem("id",r.id)):(e.removeItem("token"),e.removeItem("id"),o=new Error("登录失败")),o?i(o,r):n.getUser(t,i),n.emit("signon",o,r)})},signon_guest:function(t,i){var n=this;this.post({url:this.uri+"/signon_guest",data:t},function(t,o){!t&&o&&o.id?(e.setItem("token",o.token),e.setItem("id",o.id)):(e.removeItem("token"),e.removeItem("id"),t=new Error("登录失败")),i(t,o),n.emit("signon",t,o)})},getAvatarUri:function(t){var e=t||self.user;return e?e.headimgurl||"/upload/sso/"+e.id+"/images/avatar.jpg":"/images/avatar.png"},getUser:function(t,n){var o=this;n=n||function(){};var r=(t=t||{}).token||e.getItem("token");if(!r)return n(new Error("获取用户信息失败"),i.FA_NOAUTH);this.get({url:this.uri+"/user",data:{token:r}},function(t,i){if(!t&&i&&i.id){o.user={token:r};for(var s in i)o.user[s]=i[s];o.user.nick||(o.user.nick=""),i=o.user}else e.removeItem("token"),e.removeItem("id"),t=new Error("获取用户信息失败");n(t,i),o.emit("getUser",t,i)})},signout:function(t,i){var n=this;i=i||function(){};var o=(t=t||{}).token||e.getItem("token");o&&this.get({url:this.uri+"/signout",data:{token:o}},function(t,e){}),e.removeItem("token"),e.removeItem("id"),n.user={},i(),n.emit("signout")},updatePasswd:function(t,n){n=n||function(){};var o=(t=t||{}).token||e.getItem("token");if(!o)return n(new Error("修改密码失败"),i.FA_NOAUTH);t.token=o,this.post({url:this.uri+"/user/passwd",data:t},n)},updateUser:function(t,n){n=n||function(){};var o=(t=t||{}).token||e.getItem("token");if(!o)return n(new Error("更新用户信息失败"),i.FA_NOAUTH);t.token=o,this.post({url:this.uri+"/user",data:t},n)},getVerifyCode:function(t,e){e=e||function(){},this.get({url:this.uri+"/verifyCode",data:t},e)},checkVerifyCode:function(t,e){e=e||function(){},this.get({url:this.uri+"/verifyCode/check",data:t},e)}}}();