var jm=jm||{};"undefined"!=typeof exports&&"undefined"!=typeof module&&(jm=require("jm-sdk-core")),function(){var t=jm.sdk,e=(t.$,t.storage),i=t.consts.ERR;t.on("init",function(e){var i="sso";e[i]=e[i]||{},e[i].uri=e[i].uri||e.uri,e[i].timeout=e[i].timeout||e.timeout,t[i].init(e[i])}),t.sso={init:function(e){e=e||{};var i=e.uri,n=e.prefix||"/sso";this.uri=i+n,jm.enableEvent(this),t.enableAjax(this,{timeout:e.timeout||0})},signup:function(t,e){var i=this;e=e||function(){},this.post({url:this.uri+"/signup",data:t},function(n,r){!n&&r&&r.id||(n=new Error("注册失败")),n?e(n,r):i.signon(t,e),i.emit("signup",n,r)})},signon:function(t,i){var n=this;i=i||function(){},this.post({url:this.uri+"/signon",data:t},function(r,o){!r&&o&&o.id?(e.setItem("token",o.token),e.setItem("id",o.id)):(e.removeItem("token"),e.removeItem("id"),r=new Error("登录失败")),r?i(r,o):n.getUser(t,i),n.emit("signon",r,o)})},signon_guest:function(t,i){var n=this;this.post({url:this.uri+"/signon_guest",data:t},function(t,r){!t&&r&&r.id?(e.setItem("token",r.token),e.setItem("id",r.id)):(e.removeItem("token"),e.removeItem("id"),t=new Error("登录失败")),i(t,r),n.emit("signon",t,r)})},getAvatarUri:function(t){var e=t||self.user;return e?e.headimgurl||"/upload/sso/"+e.id+"/images/avatar.jpg":"/images/avatar.png"},getUser:function(t,n){var r=this;n=n||function(){},t=t||{};var o=t.token||e.getItem("token");return o?void this.get({url:this.uri+"/user",data:{token:o}},function(t,i){if(!t&&i&&i.id){r.user={token:o};for(var s in i)r.user[s]=i[s];r.user.nick=r.user.nick||"楼主很懒连名字都不起一下",i=r.user}else e.removeItem("token"),e.removeItem("id"),t=new Error("获取用户信息失败");n(t,i),r.emit("getUser",t,i)}):n(new Error("获取用户信息失败"),i.FA_NOAUTH)},signout:function(t,i){var n=this;i=i||function(){},t=t||{};var r=t.token||e.getItem("token");r&&this.get({url:this.uri+"/signout",data:{token:r}},function(t,e){}),e.removeItem("token"),e.removeItem("id"),n.user={},i(),n.emit("signout")},updatePasswd:function(t,n){n=n||function(){},t=t||{};var r=t.token||e.getItem("token");return r?(t.token=r,void this.post({url:this.uri+"/user/passwd",data:t},n)):n(new Error("修改密码失败"),i.FA_NOAUTH)},updateUser:function(t,n){n=n||function(){},t=t||{};var r=t.token||e.getItem("token");return r?(t.token=r,void this.post({url:this.uri+"/user",data:t},n)):n(new Error("更新用户信息失败"),i.FA_NOAUTH)},getVerifyCode:function(t,e){e=e||function(){},this.get({url:this.uri+"/verifyCode",data:t},e)},checkVerifyCode:function(t,e){e=e||function(){},this.get({url:this.uri+"/verifyCode/check",data:t},e)}}}();