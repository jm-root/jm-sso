<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: router/index.js</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"default":{"outputSourceFiles":true},"monospaceLinks":false,"cleverLinks":false,"anyTemplateSpecificParameter":"whatever"};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html"></a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="SSO">
            <span class="title">
                <a href="SSO.html">SSO</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="SSO#disableAutoUid"><a href="SSO.html#disableAutoUid">disableAutoUid</a></li>
            
                <li data-name="SSO#disableVerifyCode"><a href="SSO.html#disableVerifyCode">disableVerifyCode</a></li>
            
                <li data-name="SSO#mq"><a href="SSO.html#mq">mq</a></li>
            
                <li data-name="SSO#tokenExpire"><a href="SSO.html#tokenExpire">tokenExpire</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="SSO#checkPasswd"><a href="SSO.html#checkPasswd">checkPasswd</a></li>
            
                <li data-name="SSO#checkToken"><a href="SSO.html#checkToken">checkToken</a></li>
            
                <li data-name="SSO#checkVerifyCode"><a href="SSO.html#checkVerifyCode">checkVerifyCode</a></li>
            
                <li data-name="SSO#createToken"><a href="SSO.html#createToken">createToken</a></li>
            
                <li data-name="SSO#createVerifyCode"><a href="SSO.html#createVerifyCode">createVerifyCode</a></li>
            
                <li data-name="SSO#destroyToken"><a href="SSO.html#destroyToken">destroyToken</a></li>
            
                <li data-name="SSO#destroyVerifyCode"><a href="SSO.html#destroyVerifyCode">destroyVerifyCode</a></li>
            
                <li data-name="SSO#encryptPasswd"><a href="SSO.html#encryptPasswd">encryptPasswd</a></li>
            
                <li data-name="SSO#findByIds"><a href="SSO.html#findByIds">findByIds</a></li>
            
                <li data-name="SSO#findUser"><a href="SSO.html#findUser">findUser</a></li>
            
                <li data-name="SSO#findUsers"><a href="SSO.html#findUsers">findUsers</a></li>
            
                <li data-name="SSO#isSignon"><a href="SSO.html#isSignon">isSignon</a></li>
            
                <li data-name="SSO#saveToken"><a href="SSO.html#saveToken">saveToken</a></li>
            
                <li data-name="SSO#saveVerifyCode"><a href="SSO.html#saveVerifyCode">saveVerifyCode</a></li>
            
                <li data-name="SSO#signon"><a href="SSO.html#signon">signon</a></li>
            
                <li data-name="SSO#signon_guest"><a href="SSO.html#signon_guest">signon_guest</a></li>
            
                <li data-name="SSO#signon_noauth"><a href="SSO.html#signon_noauth">signon_noauth</a></li>
            
                <li data-name="SSO#signout"><a href="SSO.html#signout">signout</a></li>
            
                <li data-name="SSO#signup"><a href="SSO.html#signup">signup</a></li>
            
                <li data-name="SSO#touchToken"><a href="SSO.html#touchToken">touchToken</a></li>
            
                <li data-name="SSO#updatePasswd"><a href="SSO.html#updatePasswd">updatePasswd</a></li>
            
                <li data-name="SSO#updateUser"><a href="SSO.html#updateUser">updateUser</a></li>
            
                <li data-name="SSO#updateUserExt"><a href="SSO.html#updateUserExt">updateUserExt</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="user">
            <span class="title">
                <a href="user.html">user</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="user#createUid"><a href="user.html#createUid">createUid</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="index.js.html">Source: router/index.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>var _ = require('lodash');
var validator = require('validator');
var jmcommon = require('jm-common');
var consts = require('../consts/consts');
var ERROR = consts.ERR;
var express = require('express');

/**
 * @apiDefine Error
 *
 * @apiSuccess (Error 200) {Number} err 错误代码
 * @apiSuccess (Error 200) {String} msg 错误信息
 *
 * @apiExample {json} 错误:
 *     {
 *       err: 错误代码
 *       msg: 错误信息
 *     }
 */
module.exports = function(service, opts) {
    var router = express.Router(opts);

    opts = opts || {};

    service.routes = service.routes || {};
    var routes = service.routes;
    jmcommon.enableEvent(routes);

    var isMobile = function(mobile){
        var pattern = /^1[3,4,5,8]{1}[0-9]{9}$/;
        return pattern.test(mobile);
    };

    routes.all = function(req, res, next){
        var token = req.query.token || req.body.token;
        if(!token) return next();

        service.isSignon(token, function(err, id){
            if(err || !id) {
                return next();
            }

            req.id = id;
            req.token = token;
            next();
        });
    };

    routes.needSignon = function(req, res, next){
        if(!req.token){
            res.sendStatus(401);
            return;
        }
        next();
    };

    routes.validator = function(req, res, next){
        var id = req.body.id;
        var account = req.body.account;
        var uid = req.body.uid;
        var email = req.body.email;
        var mobile = req.body.mobile;
        var passwd = req.body.passwd;
        var expire = req.body.expire;
        var msg = [];
        if(uid &amp;&amp; !validator.isInt(uid)){
            msg.push('请输入正确的ID号');
        }
        if(email &amp;&amp; !validator.isEmail(email)){
            msg.push('请输入正确邮箱');
        }
        if(mobile &amp;&amp; !isMobile(mobile)){
            msg.push('请输入正确的手机号码');
        }
        if(validator.isNull(passwd)){
            msg.push('密码不能为空');
        }
        if(msg.length){
            res.send({err:ERROR.FA_PARAMS.err, msg: msg});
            return;
        }

        var data = {
        };

        if(id){
            data.id = id;
        }

        if(account){
            data.account = account;
        }

        if(uid){
            data.uid = uid;
        }

        if(email){
            data.email = email;
        }

        if(mobile){
            data.mobile = mobile;
        }

        if(passwd){
            data.passwd = passwd;
        }

        if(expire){
            data.expire = expire;
        }

        req.data = data;
        next();
    };

    routes.loadUser = function(req, res, next){
        service.user.findById(req.id, function (err, doc){
            if(err){
                return res.send(ERROR.FA_FIND_USER);
            }

            if(doc){
                req.user = doc;
                next();
            }else{
                res.send(ERROR.FA_NOT_EXIST);
            }
        });
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {post} /signon 登录
     * @apiName signon
     *
     * @apiParam {String} passwd 密码
     * @apiParam {String} [id] id
     * @apiParam {String} [uid] uid
     * @apiParam {String} [account] 账户
     * @apiParam {String} [mobile] 手机号
     * @apiParam {String} [email] 邮箱
     * @apiParam {Number} [expire] token过期时间(可选, 如果不填，采用系统默认值)
     *
     * @apiSuccess {String} token token
     * @apiSuccess {String} id id
     * @apiSuccess {Number} expire token过期时间(单位秒, 0表示不过期)
     * @apiExample {json} 成功:
     *     {
     *       token: token,
     *       id: id
     *     }
     */
    routes.signon = function(req, res) {
        var data = req.data;
        if(data.account){
            data.any = data.account;
            delete data.account;
        }
        service.signon(data, function (err, doc) {
            routes.emit('signon', req, res, err, doc);
            if (err) {
                res.send(doc);
            } else {
                res.send({token: doc.token, id: doc.id, expire: doc.expire});
            }
        });
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {post} /signon_guest 游客登录
     * @apiName signon_guest
     *
     * @apiParam {String} [passwd] 密码
     * @apiParam {String} [nick] 昵称
     * @apiParam {String} [creator] 创建者id
     *
     * @apiSuccess {String} token token
     * @apiSuccess {String} id id
     * @apiSuccess {String} [nick] 昵称
     * @apiSuccess {String} [creator] 创建者id
     * @apiExample {json} 成功:
     *     {
     *       nick: 昵称,
     *       creator: 创建者id,
     *       token: token,
     *       id: id
     *     }
     */
    routes.signon_guest = function(req, res) {
        var data = req.data || req.body || {};
        if(!service.disableVerifyCode){
            data.passwd = data.passwd || service.createVerifyCode();
        }
        service.signon_guest(_.clone(data), function (err, doc) {
            routes.emit('signon', req, res, err, doc);
            if (err) {
                res.send(doc);
            } else {
                data.token = doc.token;
                data.id = doc.id;
                data.expire = doc.expire;
                res.send(data);
            }
        });
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {post} /signup 注册
     * @apiName signup
     *
     * @apiParam {String} [passwd] 密码
     * @apiParam {String} [account] 账户
     * @apiParam {String} [mobile] 手机号
     * @apiParam {String} [email] 邮箱
     * @apiParam {String} [nick] 昵称
     * @apiParam {String} [creator] 创建者id
     *
     * @apiSuccess {String} id id
     * @apiExample {json} 成功:
     *     {
     *       id: id
     *     }
     */
    routes.signup = function (req, res) {
        var nick = req.body.nick;
        var data = req.data;

        if(data.email &amp;&amp; !nick){
            var result=data.email.split("@");
            nick = result[0];
        }

        if(nick){
            data.nick = nick;
        }

        if(routes.onSignup){
            data = routes.onSignup(req, res, data);
        }

        routes.emit('before_signup', req, res, data);

        //注册
        service.signup(data, function(err, doc){
            routes.emit('signup', req, res, err, doc);
            if(err) {
                res.send(doc);
            }else{
                res.send({id: doc.id});
            }
        });
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {get} /isSignon 是否登录
     * @apiName isSignon
     *
     * @apiParam {String} [token] token
     *
     * @apiSuccess {Boolean} ret 返回结果
     * @apiExample {json} 成功:
     *     {
     *       ret: true
     *     }
     * @apiExample {json} 失败:
     *     {
     *       ret: false
     *     }
     */
    routes.isSignon = function (req, res) {
        var isSignon = false;
        if(req.token){
            isSignon = true;
        }
        res.send({ret: isSignon});
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {get} /signout 注销
     * @apiName signout
     *
     * @apiParam {String} [token] token
     *
     * @apiExample {json} 成功:
     *     {
     *     }
     */
    routes.signout = function (req, res) {
        if (req.token) {
            service.signout(req.token, function (err, id) {
                routes.emit('signout', req, res, err, req.id);
                res.send({});
            });
        } else {
            res.send({});
        }
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {get} /user 获取个人用户信息
     * @apiName getUser
     *
     * @apiParam {String} [token] token
     *
     * @apiSuccess {String} id id
     * @apiSuccess {String} [uid] uid
     * @apiSuccess {String} [nick] 昵称
     * @apiSuccess {String} [creator] 创建者id
     * @apiExample {json} 成功:
     *     {
     *       nick: 昵称,
     *       creator: 创建者id,
     *       id: id
     *     }
     */
    routes.getUser = function(req, res){
        if(req.user) {
            var doc = req.user;
            var o = {
                id: doc.id,
                nick: doc.nick
            }
            routes.emit('getUser', req, res, doc, o);
            if(routes.onGetUser){
                o = routes.onGetUser(req, res, doc);
            }
            res.send(o);
        }
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {post} /user 更新个人用户信息
     * @apiName updateUser
     *
     * @apiParam {String} [token] token
     * @apiParam {String} [nick] 昵称
     *
     * @apiExample {json} 成功:
     *     {
     *     }
     */
    routes.updateUser = function(req, res){
        service.updateUser(req.id, req.body, function (err, doc){
            routes.emit('updateUser', req, res, err, doc);
            if(err){
                res.send(doc);
                return;
            }
            res.send({});
        });
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {post} /user/ext 更新个人扩展用户信息
     * @apiName updateUserExt
     *
     * @apiParam {String} [token] token
     * @apiParam {String} [key] 键
     *
     * @apiExample {json} 成功:
     *     {
     *     }
     */
    routes.updateUserExt = function(req, res){
        service.updateUserExt(req.id, req.body, false, function (err, doc){
            routes.emit('updateUserExt', req, res, err, doc);
            if(err){
                res.send(doc);
                return;
            }
            res.send({});
        });
    };

    /**
     * @apiGroup sso
     * @apiVersion 0.0.1
     * @apiUse Error
     *
     * @api {post} /user/ext 更新个人密码
     * @apiName updatePasswd
     *
     * @apiParam {String} [token] token
     * @apiParam {String} [newPasswd] 新密码
     *
     * @apiExample {json} 成功:
     *     {
     *     }
     */
    routes.updatePasswd = function(req, res){
        var data = req.data;
        data.newPasswd = req.body.newPasswd;
        data.id = req.id;
        service.updatePasswd(data, function (err, doc){
            routes.emit('updatePasswd', req, res, err, doc);
            if(err){
                res.send(doc);
                return;
            }
            res.send({});
        });
    };

    var _all = function(req, res, next){routes.all(req, res, next);};
    var _needSignon = function(req, res, next){routes.needSignon(req, res, next);};
    var _validator = function(req, res, next){routes.validator(req, res, next);};
    var _loadUser = function(req, res, next){routes.loadUser(req, res, next);};
    var _signon = function(req, res, next){routes.signon(req, res, next);};
    var _signon_guest = function(req, res, next){routes.signon_guest(req, res, next);};
    var _signup = function(req, res, next){routes.signup(req, res, next);};
    var _isSignon = function(req, res, next){routes.isSignon(req, res, next);};
    var _signout = function(req, res, next){routes.signout(req, res, next);};
    var _getUser = function(req, res, next){routes.getUser(req, res, next);};
    var _updateUser = function(req, res, next){routes.updateUser(req, res, next);};
    var _updateUserExt = function(req, res, next){routes.updateUserExt(req, res, next);};
    var _updatePasswd = function(req, res, next){routes.updatePasswd(req, res, next);};

    router.use(_all);
    //router.use('/' + service.user.modelName + 's', jmcommon.router(service.user, opts));

    router.post('/signup', _validator, _signup);
    router.post('/signon', _validator, _signon);
    router.post('/signon_guest', _signon_guest);
    router.all ('/signout', _signout);
    router.all ('/isSignon', _isSignon);
    router.post('/user/passwd', _needSignon, _validator, _updatePasswd);
    router.get ('/user', _needSignon, _loadUser, _getUser);
    router.post('/user', _needSignon, _updateUser);
    router.post('/user/ext', _needSignon, _updateUserExt);

    if (!service.disableVerifyCode) {
        router.use('/verifyCode', require('./verifyCode')(service, opts));
    }

    return router;
};

</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Wed Sep 14 2016 15:54:25 GMT+0800 (中国标准时间)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
